# シャッフルのバリエーション設計（頭文字／カテゴリ）

## 目的
- 認知シャッフル（SDI）を行いやすくするため、ユーザーが取り組みやすい「型」を複数用意し、好みや状況に合わせて選べるようにする。
- どの型でも共通の原則は「関連性を作らない」「短く区切る」。アプリはこの原則を支援する順序付け・待機制御を行う。

---

## バリエーション（型）

### 1) 頭文字シャッフル（Letter-based）
- 五十音の任意の1文字から始め、その文字で始まる言葉だけを短く並べる。
- 例（出発語「すいみん」→「す」から）: すいか、すなのつぶ、スリッパ…（1〜2語/文字を目安に次の文字へ）

実装指針（アプリ）:
- cue語（かな列）を入力 → 文字ごとにDB/辞書から該当語をピックアップ
- 1〜3件/文字を上限にして短く切替（5〜10秒のサイレント含む）
- 出にくくなったら次の文字へ自動遷移（fallback: ランダム安全語）
 - 実装では各頭文字ごとの語群を事前にシャッフルし、頭文字をランダム順にラウンドロビンで1語ずつ消費（ある頭文字が尽きたらスキップして次へ）

### 2) カテゴリシャッフル（Category-mix）
- 果物→家の中の物→地名→動物→文房具…のように、ジャンル（カテゴリ）を次々に切り替える。

実装指針（アプリ）:
- カテゴリの巡回順をあらかじめ決める/ランダム化する
- 各カテゴリから1〜2件ずつ取り出して局所シャッフル（連想の固定化を避ける）
- 直近カテゴリの連続を避ける制約（balancedBlocks）を適用


---

## うまくいくためのコツ（アプリ提示テキストに反映）
- 映像は薄く・短く（映画のように作り込まない。色や形の断片で十分）
- 感情が強く動く題材は避ける（仕事/人間関係/ニュースなどは外す）
- 同じ出発語は続けない（毎回異なる語にしてマンネリ回避）

アプリ側の支援:
- DBフィルタ（`isImaginable=1 AND isEmotionallyNeutral=1`）で安全語のみ使用
- 滞在時間はエンジン側のサイレントで挿入（5〜10秒）
- 直近の重複（同カテゴリ・同頭文字）に軽いペナルティ

---

## 例（頭文字シャッフル）
出発語「すいみん」

- す: すいか、すなのつぶ、スリッパ
- い: いちご、いす、いわ
- み: みかづき、みずたまり、みどり
- ん: んー（スキップ）→ 次の出発語へ（例:「そら」→ そ：そば、そり、そよかぜ…）

---

## アプリモードへのマッピング（現行UIとの対応）
- タイル「ランダム」: 完全ランダム（無限シーケンス）。balancedBlocks最小限
- タイル「寝やすい順序」: スコア（短尺/想像しやすい/中性）＋カテゴリ交互（`balancedBlocks`）
- タイル「文字ベース」: 頭文字シャッフル（cue語入力UIは将来対応、暫定はプリセット）

将来追加候補:
- タイル「カテゴリ」: カテゴリシャッフルを固定の巡回順で
- タイル「場面」: place中心の短尺切替（2〜3秒/場面）

---

## 疑似コード（最小スケッチ）

### Letter-based（頭文字）
```kotlin
fun letterBased(cue: String, dict: Dao): Sequence<AudioWord> = sequence {
  val kana = cue.toHiraganaList()
  for (ch in kana) {
    val items = dict.findByHeadKana(ch).shuffled().take(3) // 1〜3件
    for (w in items) yield(w)
  }
}
```

### Category-mix（カテゴリ交互）
```kotlin
fun categoryMix(cats: List<String>, dict: Dao): Sequence<AudioWord> = sequence {
  val pools = cats.associateWith { dict.byCategory(it).shuffled() }.toMutableMap()
  while (true) {
    for (c in cats) {
      val pool = pools[c] ?: emptyList()
      if (pool.isNotEmpty()) yield(pool.random())
    }
  }
}
```



---

## 実装段階の提案
1. Phase A: 既存「ランダム」「寝やすい順序」をmode分岐で適用（UIタイルと連動）
2. Phase B: 「文字ベース」を簡易対応（プリセットcue語で頭文字列挙）
3. Phase C: 「カテゴリ」を拡充（placeカテゴリの拡充など）

---

## 備考
- 10〜15分で眠気が来なければ、いったん離床→単調行動→再入床（アプリ内Tipsで案内）
- 評価しない・短く区切る・感情が動く題材は避ける、をUI文言で再確認できるようにする


